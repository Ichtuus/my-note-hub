version: "2.3"

services:
  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    volumes:
      - .:/var/www/symfony/
    networks:
      - mynotehub
    links:
      - database
    depends_on:
      - database

  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    volumes:
      - .:/var/www/symfony/
    ports:
      - 8000:80
    networks:
      - mynotehub
    depends_on:
      - php
    links:
      - php

  mercure:
    image: dunglas/mercure
    ports:
      - '3000:80'
    environment:
      - JWT_KEY=${MERCURE_JWT_TOKEN}
      - PUBLISH_ALLOWED_ORIGINS=*
      - CORS_ALLOWED_ORIGINS=*
      - ALLOW_ANONYMOUS=1
      - DEBUG=1
      - DEMO=1
    networks:
      - mynotehub

  database:
    image: "mysql:5.7"
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: mnh
      MYSQL_USER: ichtus
      MYSQL_PASSWORD: mnh
    networks:
      mynotehub:
        ipv4_address: 172.119.1.3


networks:
  mynotehub:
    ipam:
      driver: default
      config:
        - subnet: 172.119.0.0/16
          ip_range: 172.119.1.0/24
          gateway: 172.119.0.254

#
#  caddy:
#    build:
#      context: .
#      target: symfony_caddy
#    environment:
#      SERVER_NAME: my-note-hub.localhost
#    restart: unless-stopped
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - caddy_data:/data
#      - caddy_config:/config
#    networks:
#      - mynotehub
#    links:
#      - php
#      - database

volumes:
#  caddy_data:
#  caddy_config:

###> doctrine/doctrine-bundle ###
  mysql_data:
    driver: local
###< doctrine/doctrine-bundle ###
